---
import Search from './Search.astro';
import { SITE_TITLE } from '../consts';

const BASE_URL = import.meta.env.BASE_URL;
const currentPath = Astro.url.pathname;
const isEnglish = currentPath.startsWith('/en');
const langPrefix = isEnglish ? '/en' : '';
---
<script is:inline define:vars={{ BASE_URL }}>
    function applyTheme(theme) {
        if (!theme) {
            if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
                theme = localStorage.getItem('theme');
            } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                theme = 'dark';
            } else {
                theme = 'paper';
            }
        }
        
        document.documentElement.setAttribute('data-theme', theme);
        
        if (theme === 'space' || theme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', theme);
    }

    // Initial Apply
    applyTheme();

    function initHeader() {
        // Re-apply theme on navigation to ensure state persistence
        applyTheme(localStorage.getItem('theme'));

        const searchBtn = document.getElementById('search-btn');
        searchBtn?.addEventListener('click', () => {
            window.dispatchEvent(new CustomEvent('open-search'));
        });

        const langBtn = document.getElementById('lang-btn');
        const langDropdown = document.getElementById('lang-dropdown');
        const langOptions = document.querySelectorAll('.lang-option');
        
        // Handle Base URL for language switching
        const getCleanPath = (path) => {
            // Remove Base URL from path if present
            if (BASE_URL && BASE_URL !== '/' && path.startsWith(BASE_URL)) {
                return path.substring(BASE_URL.length) || '/';
            }
            return path;
        };

        langBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            langDropdown?.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!langDropdown?.classList.contains('hidden') && !langBtn?.contains(e.target as Node)) {
                langDropdown?.classList.add('hidden');
            }
        });

        langOptions.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const targetLang = e.currentTarget.getAttribute('data-lang');
                const currentPath = window.location.pathname;
                const cleanPath = getCleanPath(currentPath);
                const isEnglish = cleanPath.startsWith('/en');
                
                let newPath = cleanPath;

                if (targetLang === 'ko' && isEnglish) {
                    // Switch to Korean: remove /en prefix
                    newPath = cleanPath.replace(/^\/en/, '') || '/';
                } else if (targetLang === 'en' && !isEnglish) {
                    // Switch to English: add /en prefix
                    newPath = `/en${cleanPath === '/' ? '' : cleanPath}`;
                }

                // Re-attach Base URL if needed. Ensure no double slashes.
                const baseUrl = BASE_URL === '/' ? '' : BASE_URL;
                const finalPath = baseUrl + newPath;

                if (finalPath !== currentPath) {
                    window.location.href = finalPath;
                }
                langDropdown?.classList.add('hidden');
            });
        });

        // Theme Logic
        const themeBtn = document.getElementById('theme-btn');
        const themeDropdown = document.getElementById('theme-dropdown');
        const themeOptions = document.querySelectorAll('.theme-option');

        themeBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            themeDropdown?.classList.toggle('hidden');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!themeDropdown?.classList.contains('hidden') && !themeBtn?.contains(e.target as Node)) {
                themeDropdown?.classList.add('hidden');
            }
        });

        themeOptions.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const value = e.currentTarget.getAttribute('data-value');
                applyTheme(value);
                themeDropdown?.classList.add('hidden');
            });
        });
    }

    // Initialize on first load
    initHeader();

    // Re-initialize on View Transition
    document.addEventListener('astro:page-load', initHeader);
</script>
